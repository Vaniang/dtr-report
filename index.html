<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DepEd DTR Monitoring System V2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { overflow-x: hidden; background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #sidebar-wrapper {
            min-height: 100vh;
            margin-left: -16rem;
            transition: margin .25s ease-out;
            background-color: #212529;
            color: white;
            width: 16rem;
        }
        #sidebar-wrapper .sidebar-heading { padding: 1.2rem; font-size: 1.2rem; border-bottom: 1px solid #343a40; background: #1a1e21; }
        #sidebar-wrapper .list-group-item { background-color: transparent; color: #ced4da; border: none; padding: 12px 20px; }
        #sidebar-wrapper .list-group-item:hover { background-color: #343a40; color: #fff; }
        #sidebar-wrapper .list-group-item.active { background-color: #0d6efd; color: #fff; border-left: 4px solid #fff; }
        #wrapper.toggled #sidebar-wrapper { margin-left: 0; }
        .stat-card { border-radius: 10px; border: none; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .table-custom th { background-color: #e9ecef; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .avatar-initial { width: 30px; height: 30px; background-color: #e9ecef; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: #495057; font-size: 0.8rem; margin-right: 10px; }
    </style>
</head>
<body>

<div class="d-flex" id="wrapper">
    <div class="border-end" id="sidebar-wrapper">
        <div class="sidebar-heading fw-bold"><i class="bi bi-building-check me-2"></i> DTR MANAGER</div>
        <div class="list-group list-group-flush mt-3">
            <a href="#" class="list-group-item list-group-item-action active" onclick="showView('dashboard', this)">
                <i class="bi bi-grid-1x2 me-2"></i> Dashboard
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showView('encoding', this)">
                <i class="bi bi-calendar-week me-2"></i> Monthly Encoding
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showView('employees', this)">
                <i class="bi bi-people me-2"></i> Master Employee List
            </a>
        </div>
    </div>

    <div id="page-content-wrapper" class="w-100">
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-4 py-3 shadow-sm">
            <button class="btn btn-outline-dark btn-sm me-3" id="menu-toggle"><i class="bi bi-list"></i></button>
            <div class="fw-bold text-dark fs-5">Region I - San Fernando City (La Union)</div>
        </nav>

        <div class="container-fluid p-4">
            
            <div id="view-dashboard">
                <h4 class="mb-4 text-secondary">Overview</h4>
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm h-100 bg-primary text-white">
                            <div class="card-body">
                                <h6 class="opacity-75">Master List</h6>
                                <h2 class="fw-bold display-6" id="dash-master-count">0</h2>
                                <small>Registered Employees</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Encoded This Month</h6>
                                <h2 class="fw-bold display-6 text-dark" id="dash-month-count">0</h2>
                                <small class="text-success" id="dash-month-label">Current Month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card shadow-sm h-100 border-start border-4 border-warning">
                            <div class="card-body">
                                <h6 class="text-muted">Travel / Leave</h6>
                                <h2 class="fw-bold display-6 text-dark" id="dash-issues">0</h2>
                                <small>Records with notes</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-employees" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-secondary">Master Employee List</h4>
                    <div class="card p-2 border-0 shadow-sm bg-light">
                        <div class="d-flex align-items-center gap-2">
                            <input type="file" id="masterUpload" class="form-control form-control-sm" accept=".xlsx" style="width: 200px;">
                            <button class="btn btn-sm btn-dark" onclick="importMasterList()">
                                <i class="bi bi-cloud-upload me-1"></i> Import from Template
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 70vh;">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th>#</th>
                                        <th>Employee Name</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="masterTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-encoding" class="d-none">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-6">
                        <h4 class="text-secondary mb-0">Monthly Report Encoding</h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-inline-flex align-items-center gap-2 bg-white p-2 rounded shadow-sm">
                            <label class="fw-bold small text-muted">Month:</label>
                            <input type="month" id="filterMonth" class="form-control form-control-sm" style="width: 150px;">
                            <button class="btn btn-primary btn-sm" onclick="populateMonth()">
                                <i class="bi bi-person-plus-fill me-1"></i> Load Employees
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 60vh;">
                            <table class="table table-bordered table-sm table-hover table-custom mb-0" style="font-size: 0.85rem;">
                                <thead class="text-center sticky-top shadow-sm">
                                    <tr>
                                        <th rowspan="2" class="align-middle bg-light">Employee Name</th>
                                        <th rowspan="2" class="align-middle bg-light" style="width: 100px;">Travel</th>
                                        <th rowspan="2" class="align-middle bg-light" style="width: 100px;">Leave</th>
                                        <th colspan="3" class="bg-light text-danger">Tardiness</th>
                                        <th colspan="3" class="bg-light text-warning">Undertime</th>
                                        <th colspan="2" class="bg-light text-success">Grand Total</th>
                                        <th rowspan="2" class="align-middle bg-light">Action</th>
                                    </tr>
                                    <tr class="bg-light">
                                        <th>Days</th><th>Mins</th><th>Conv</th>
                                        <th>Days</th><th>Mins</th><th>Conv</th>
                                        <th>Days</th><th>Conv</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card bg-success-subtle border-success">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="card-title text-success fw-bold"><i class="bi bi-file-earmark-excel"></i> Generate Final Report</h5>
                            <p class="mb-0 small text-success-emphasis">Upload the 'DTR 2026.xlsx' file. The system will fill the data for the selected month.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <input type="file" id="templateFile" class="form-control" accept=".xlsx">
                            <button class="btn btn-success" id="btnGenerate">Download Excel</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="modalTitle">Edit Record</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <h5 id="editNameDisplay" class="text-primary fw-bold mb-3"></h5>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="small text-muted">Travel Dates (e.g. 6-9, 15)</label>
                        <input type="text" id="inpTravel" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="small text-muted">Leave Dates (e.g. 29-30)</label>
                        <input type="text" id="inpLeave" class="form-control">
                    </div>
                </div>
                <hr>
                <div class="row g-3 text-center">
                    <div class="col-md-4">
                        <div class="p-2 bg-light border rounded">
                            <h6 class="text-danger small fw-bold">TARDINESS</h6>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text">Days</span>
                                <input type="number" id="inpTardyDays" class="form-control">
                            </div>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text">Mins</span>
                                <input type="number" id="inpTardyMins" class="form-control">
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Conv</span>
                                <input type="number" id="inpTardyConv" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-2 bg-light border rounded">
                            <h6 class="text-warning text-dark small fw-bold">UNDERTIME</h6>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text">Days</span>
                                <input type="number" id="inpUnderDays" class="form-control">
                            </div>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text">Mins</span>
                                <input type="number" id="inpUnderMins" class="form-control">
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Conv</span>
                                <input type="number" id="inpUnderConv" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-2 bg-light border rounded">
                            <h6 class="text-success small fw-bold">GRAND TOTAL</h6>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text">Days</span>
                                <input type="number" id="inpTotalDays" class="form-control">
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Conv</span>
                                <input type="number" id="inpTotalConv" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSave">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaU2vOGHM4ugJXGhFLmrAJdXi1bPr8wig",
      authDomain: "dtr-report.firebaseapp.com",
      projectId: "dtr-report",
      storageBucket: "dtr-report.firebasestorage.app",
      messagingSenderId: "759250910768",
      appId: "1:759250910768:web:184cdd2fdd8e30c17cf7f5",
      measurementId: "G-HD3V51NGL7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const reportsCol = collection(db, "monthly_reports");
    const employeesCol = collection(db, "master_employees");

    let currentReportData = [];
    let masterList = [];

    // --- INITIALIZATION ---
    // Set default month to current month
    const now = new Date();
    const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('filterMonth').value = currentMonthStr;

    // --- SIDEBAR NAV ---
    window.showView = (viewName, link) => {
        document.querySelectorAll('#sidebar-wrapper .list-group-item').forEach(el => el.classList.remove('active'));
        if(link) link.classList.add('active');
        
        ['dashboard', 'encoding', 'employees'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('d-none');
        });
        document.getElementById(`view-${viewName}`).classList.remove('d-none');
    };
    document.getElementById("menu-toggle").addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("wrapper").classList.toggle("toggled");
    });

    // --- LOGIC: MASTER EMPLOYEE LIST ---
    
    // Load Master List Realtime
    onSnapshot(query(employeesCol), (snap) => {
        masterList = [];
        const tbody = document.getElementById('masterTableBody');
        tbody.innerHTML = '';
        
        snap.forEach(d => {
            const data = d.data();
            data.id = d.id;
            masterList.push(data);
            
            tbody.innerHTML += `
                <tr>
                    <td>${masterList.length}</td>
                    <td class="fw-bold">${data.name}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMaster('${data.id}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        });
        document.getElementById('dash-master-count').innerText = masterList.length;
    });

    window.deleteMaster = async (id) => {
        if(confirm("Remove from Master List?")) await deleteDoc(doc(db, "master_employees", id));
    }

    // Import Logic (Reads DTR 2026.xlsx format)
    window.importMasterList = () => {
        const fileIn = document.getElementById('masterUpload');
        if(!fileIn.files[0]) return alert("Select a file first.");

        const reader = new FileReader();
        reader.readAsArrayBuffer(fileIn.files[0]);
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1});

            // Batch write to Firestore
            const batch = writeBatch(db);
            let count = 0;

            // Start from row 16 (Index 16 in code is Row 17 in Excel, assume data starts around there)
            // Based on your CSV, the header "NAME OF EMPLOYEE" is at row index 14. Data likely starts index 16.
            for(let i=16; i < jsonData.length; i++) {
                const row = jsonData[i];
                // Name is Column C (Index 2)
                const name = row[2]; 
                
                // Stop if name is empty or hits "Prepared by"
                if(!name || (typeof name === 'string' && name.includes("Prepared by"))) continue;

                // Check duplicates in local list before adding
                if(!masterList.some(m => m.name === name)) {
                    const newDocRef = doc(employeesCol); // Auto ID
                    batch.set(newDocRef, { name: name });
                    count++;
                }
            }

            if(count > 0) {
                await batch.commit();
                alert(`Successfully imported ${count} new employees to Master List.`);
            } else {
                alert("No new employees found or file format issue.");
            }
        };
    };

    // --- LOGIC: MONTHLY REPORTING ---

    const monthPicker = document.getElementById('filterMonth');

    // 1. Load Data for Selected Month
    function loadMonthData() {
        const selectedMonth = monthPicker.value;
        document.getElementById('dash-month-label').innerText = selectedMonth;

        const q = query(reportsCol, where("month", "==", selectedMonth));
        onSnapshot(q, (snap) => {
            currentReportData = [];
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            let issuesCount = 0;

            snap.forEach(d => {
                const data = d.data();
                data.id = d.id;
                currentReportData.push(data);
                
                if(data.travel || data.leave) issuesCount++;

                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-dark"><div class="d-flex align-items-center"><span class="avatar-initial">${data.name.charAt(0)}</span>${data.name}</div></td>
                        <td class="text-secondary small">${data.travel || ''}</td>
                        <td class="text-secondary small">${data.leave || ''}</td>
                        <td class="text-center text-danger">${data.tardyDays || ''}</td>
                        <td class="text-center text-danger">${data.tardyMins || ''}</td>
                        <td class="text-center text-danger">${data.tardyConv || ''}</td>
                        <td class="text-center text-warning text-dark">${data.underDays || ''}</td>
                        <td class="text-center text-warning text-dark">${data.underMins || ''}</td>
                        <td class="text-center text-warning text-dark">${data.underConv || ''}</td>
                        <td class="text-center fw-bold text-success">${data.totalDays || ''}</td>
                        <td class="text-center fw-bold text-success">${data.totalConv || ''}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-light border" onclick="window.editRec('${data.id}')"><i class="bi bi-pencil-fill text-primary"></i></button>
                        </td>
                    </tr>
                `;
            });
            document.getElementById('dash-month-count').innerText = currentReportData.length;
            document.getElementById('dash-issues').innerText = issuesCount;
        });
    }
    monthPicker.addEventListener('change', loadMonthData);
    loadMonthData(); // Init

    // 2. Populate Month (The Automation Feature)
    window.populateMonth = async () => {
        if(masterList.length === 0) return alert("Your Master List is empty. Go to 'Master Employee List' and import your template first.");
        const selectedMonth = monthPicker.value;

        // Find which employees are missing for this month
        const missingEmployees = masterList.filter(m => !currentReportData.some(r => r.name === m.name));

        if(missingEmployees.length === 0) return alert("All employees are already added for this month.");

        if(confirm(`Add ${missingEmployees.length} employees to ${selectedMonth} report?`)) {
            const batch = writeBatch(db);
            missingEmployees.forEach(emp => {
                const newRef = doc(reportsCol);
                batch.set(newRef, {
                    month: selectedMonth,
                    name: emp.name,
                    travel: "", leave: "",
                    tardyDays: "", tardyMins: "", tardyConv: "",
                    underDays: "", underMins: "", underConv: "",
                    totalDays: "", totalConv: ""
                });
            });
            await batch.commit();
            alert("Employees added successfully!");
        }
    };

    // 3. Edit Record
    window.editRec = (id) => {
        const rec = currentReportData.find(r => r.id === id);
        if(!rec) return;

        document.getElementById('editId').value = rec.id;
        document.getElementById('editNameDisplay').innerText = rec.name;
        
        // Fill fields
        ['Travel','Leave','TardyDays','TardyMins','TardyConv','UnderDays','UnderMins','UnderConv','TotalDays','TotalConv'].forEach(field => {
            const key = field.charAt(0).toLowerCase() + field.slice(1);
            document.getElementById(`inp${field}`).value = rec[key] || '';
        });

        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    };

    document.getElementById('btnSave').addEventListener('click', async () => {
        const id = document.getElementById('editId').value;
        const payload = {};
        
        ['Travel','Leave','TardyDays','TardyMins','TardyConv','UnderDays','UnderMins','UnderConv','TotalDays','TotalConv'].forEach(field => {
            const key = field.charAt(0).toLowerCase() + field.slice(1);
            payload[key] = document.getElementById(`inp${field}`).value;
        });

        await updateDoc(doc(db, "monthly_reports", id), payload);
        
        const modalEl = document.getElementById('editModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    });

    // 4. Generate Excel
    document.getElementById('btnGenerate').addEventListener('click', () => {
        const fileInput = document.getElementById('templateFile');
        if (!fileInput.files[0]) return alert("Please upload the template file first.");
        
        const reader = new FileReader();
        reader.readAsArrayBuffer(fileInput.files[0]);

        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const sheetData = XLSX.utils.sheet_to_json(sheet, {header: 1});

            currentReportData.forEach(rec => {
                // Find row by Name (Column C / Index 2)
                let rowIdx = -1;
                for(let i=0; i < sheetData.length; i++) {
                    if(sheetData[i][2] && typeof sheetData[i][2] === 'string' && sheetData[i][2].includes(rec.name)) {
                        rowIdx = i; break;
                    }
                }

                if(rowIdx !== -1) {
                    const write = (col, val) => {
                        const cellRef = XLSX.utils.encode_cell({c: col, r: rowIdx});
                        if(!sheet[cellRef]) sheet[cellRef] = {t:'s', v:''};
                        sheet[cellRef].v = val;
                    };

                    if(rec.travel) write(3, rec.travel);
                    if(rec.leave) write(4, rec.leave);
                    
                    if(rec.tardyDays) write(5, Number(rec.tardyDays));
                    if(rec.tardyMins) write(6, Number(rec.tardyMins));
                    if(rec.tardyConv) write(7, Number(rec.tardyConv));
                    
                    if(rec.underDays) write(8, Number(rec.underDays));
                    if(rec.underMins) write(9, Number(rec.underMins));
                    if(rec.underConv) write(10, Number(rec.underConv));
                    
                    if(rec.totalDays) write(11, Number(rec.totalDays));
                    if(rec.totalConv) write(12, Number(rec.totalConv));
                }
            });

            XLSX.writeFile(workbook, `DTR_Report_${monthPicker.value}.xlsx`);
        };
    });

</script>
</body>
</html>

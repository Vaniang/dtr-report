<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DepEd DTR System (Official Template)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { overflow-x: hidden; background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Sidebar Styles */
        #sidebar-wrapper {
            min-height: 100vh;
            margin-left: -17rem;
            transition: margin .25s ease-out;
            background-color: #212529;
            color: white;
            width: 17rem;
            position: fixed;
            z-index: 1000;
        }
        #sidebar-wrapper .sidebar-heading { padding: 1.5rem 1.2rem; font-size: 1.1rem; border-bottom: 1px solid #343a40; background: #1a1e21; letter-spacing: 1px; }
        #sidebar-wrapper .list-group-item { background-color: transparent; color: #adb5bd; border: none; padding: 14px 25px; transition: all 0.2s; }
        #sidebar-wrapper .list-group-item:hover { background-color: #343a40; color: #fff; padding-left: 30px; }
        #sidebar-wrapper .list-group-item.active { background-color: #0d6efd; color: #fff; border-right: 4px solid #fff; font-weight: 600; }
        
        #page-content-wrapper { width: 100%; margin-left: 0; transition: margin .25s ease-out; padding-left: 0; }
        #wrapper.toggled #sidebar-wrapper { margin-left: 0; }
        #wrapper.toggled #page-content-wrapper { margin-left: 17rem; }
        
        @media (min-width: 768px) {
            #sidebar-wrapper { margin-left: 0; }
            #page-content-wrapper { margin-left: 17rem; }
            #wrapper.toggled #sidebar-wrapper { margin-left: -17rem; }
            #wrapper.toggled #page-content-wrapper { margin-left: 0; }
        }

        .stat-card { border: none; border-radius: 12px; transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .table-custom th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; vertical-align: middle; text-align: center; }
        .table-custom td { font-size: 0.85rem; vertical-align: middle; }
        .calc-input:focus { border-color: #198754; box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25); }
        .col-name { min-width: 200px; }

        /* Print Styles */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .table-print { width: 100%; border-collapse: collapse; font-size: 12px; }
            .table-print th, .table-print td { border: 1px solid black; padding: 4px; text-align: center; }
            .table-print th { background-color: #f0f0f0; }
            .table-print .text-left { text-align: left; }
            .print-header { text-align: center; margin-bottom: 20px; }
            .print-header h4, .print-header h5 { margin: 5px 0; }
            @page { size: landscape; margin: 10mm; }
        }
    </style>
</head>
<body>

<div class="d-flex" id="wrapper">
    <div class="border-end" id="sidebar-wrapper">
        <div class="sidebar-heading fw-bold"><i class="bi bi-building-check me-2"></i> HR MONITORING</div>
        <div class="list-group list-group-flush mt-3">
            <a href="#" class="list-group-item list-group-item-action active" onclick="showView('dashboard', this)">
                <i class="bi bi-grid-1x2 me-2"></i> Dashboard
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showView('encoding', this)">
                <i class="bi bi-calendar-week me-2"></i> Monthly Encoding
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showView('consolidation', this)">
                <i class="bi bi-folder2-open me-2"></i> Consolidated Report
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showView('employees', this)">
                <i class="bi bi-people me-2"></i> Master Employee List
            </a>
        </div>
    </div>

    <div id="page-content-wrapper">
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-4 py-3 shadow-sm sticky-top">
            <button class="btn btn-outline-dark btn-sm me-3" id="menu-toggle"><i class="bi bi-list"></i></button>
            <div class="fw-bold text-dark fs-5">Region I - San Fernando City (La Union)</div>
        </nav>

        <div class="container-fluid p-4">
            
            <div id="view-dashboard">
                <h4 class="mb-4 text-secondary">Dashboard Overview</h4>
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="card stat-card bg-primary text-white h-100">
                            <div class="card-body">
                                <h6 class="opacity-75">Total Employees</h6>
                                <h2 class="fw-bold display-6" id="dash-master-count">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card bg-white h-100">
                            <div class="card-body">
                                <h6 class="text-muted">Current Month Records</h6>
                                <h2 class="fw-bold display-6 text-dark" id="dash-month-count">0</h2>
                                <small class="text-success" id="dash-month-label">--</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-encoding" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="text-secondary mb-0">Monthly Report Encoding</h4>
                    <div class="d-flex align-items-center gap-2 bg-white p-2 rounded shadow-sm">
                        <label class="fw-bold small text-muted">Select Month:</label>
                        <input type="month" id="filterMonth" class="form-control form-control-sm" style="width: 160px;">
                        <button class="btn btn-primary btn-sm" onclick="populateMonth()">
                            <i class="bi bi-download me-1"></i> Load Master List
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 65vh;">
                            <table class="table table-bordered table-sm table-hover table-custom mb-0">
                                <thead class="text-center sticky-top shadow-sm bg-light">
                                    <tr>
                                        <th rowspan="2" class="bg-light col-name">NAME OF EMPLOYEE</th>
                                        <th rowspan="2" class="bg-light">TRAVEL</th>
                                        <th rowspan="2" class="bg-light">LEAVE</th>
                                        <th colspan="3" class="bg-light text-danger">TARDINESS</th>
                                        <th colspan="3" class="bg-light text-warning">UNDERTIME</th>
                                        <th colspan="2" class="bg-light text-success">GRAND TOTAL</th>
                                        <th rowspan="2" class="bg-light" style="min-width:150px;">REMARKS</th>
                                        <th rowspan="2" class="bg-light">Action</th>
                                    </tr>
                                    <tr class="bg-light">
                                        <th>No. of Days</th>
                                        <th>Minutes</th>
                                        <th>Conversion</th>
                                        <th>No. of Days</th>
                                        <th>Minutes</th>
                                        <th>Conversion</th>
                                        <th>No. of Days</th>
                                        <th>Conversion</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button class="btn btn-success me-md-2" type="button" id="btnSaveReport">
                        <i class="bi bi-save-fill me-1"></i> Save Final Report
                    </button>
                </div>
            </div>

            <div id="view-consolidation" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-secondary">Saved Monthly Reports</h4>
                    <button class="btn btn-dark btn-sm" onclick="loadSavedReports()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh List
                    </button>
                </div>
                
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Report Name</th>
                                        <th>Month</th>
                                        <th>Date Saved</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="savedReportsBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-employees" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-secondary">Master Employee List</h4>
                    <div class="d-flex gap-2">
                        <input type="file" id="masterUpload" class="form-control form-control-sm" accept=".xlsx">
                        <button class="btn btn-dark btn-sm" onclick="importMasterList()">Import Template</button>
                    </div>
                </div>
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 70vh;">
                            <table class="table table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>#</th>
                                        <th>Name (A-Z)</th>
                                        <th class="text-end">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="masterTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Edit Attendance Record</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <h4 id="editNameDisplay" class="mb-3 text-primary"></h4>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Travel Dates (e.g. 7-9)</label>
                        <input type="text" id="inpTravel" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Leave Dates (e.g. 21-22)</label>
                        <input type="text" id="inpLeave" class="form-control">
                    </div>
                </div>
                <hr>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="p-2 bg-light rounded border">
                            <h6 class="text-danger small fw-bold text-center">TARDINESS</h6>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text" style="width:90px">No. of Days</span>
                                <input type="number" id="inpTardyDays" class="form-control calc-input">
                            </div>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text" style="width:90px">Minutes</span>
                                <input type="number" id="inpTardyMins" class="form-control">
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text" style="width:90px">Conversion</span>
                                <input type="number" id="inpTardyConv" class="form-control calc-input">
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="p-2 bg-light rounded border">
                            <h6 class="text-warning text-dark small fw-bold text-center">UNDERTIME</h6>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text" style="width:90px">No. of Days</span>
                                <input type="number" id="inpUnderDays" class="form-control calc-input">
                            </div>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text" style="width:90px">Minutes</span>
                                <input type="number" id="inpUnderMins" class="form-control">
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text" style="width:90px">Conversion</span>
                                <input type="number" id="inpUnderConv" class="form-control calc-input">
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="p-2 bg-success-subtle rounded border border-success">
                            <h6 class="text-success small fw-bold text-center">GRAND TOTAL</h6>
                            <div class="input-group input-group-sm mb-1">
                                <span class="input-group-text fw-bold">No. of Days</span>
                                <input type="number" id="inpTotalDays" class="form-control fw-bold bg-white" readonly>
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text fw-bold">Conversion</span>
                                <input type="number" id="inpTotalConv" class="form-control fw-bold bg-white" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label small fw-bold">Remarks</label>
                    <textarea id="inpRemarks" class="form-control" rows="2" placeholder="Enter remarks here..."></textarea>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSave">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div id="print-area">
    <div class="print-header">
        <h4>DEPARTMENT OF EDUCATION</h4>
        <h5>Region I</h5>
        <h5>San Fernando City (La Union)</h5>
        <h5 class="mt-4" id="print-title">Daily Time Record Report</h5>
    </div>
    <table class="table-print">
        <thead>
            <tr>
                <th rowspan="2" class="text-left" style="width: 25%;">NAME OF EMPLOYEE</th>
                <th rowspan="2" style="width: 10%;">TRAVEL</th>
                <th rowspan="2" style="width: 10%;">LEAVE</th>
                <th colspan="3">TARDINESS</th>
                <th colspan="3">UNDERTIME</th>
                <th colspan="2">GRAND TOTAL</th>
                <th rowspan="2" style="width: 10%;">REMARKS</th>
            </tr>
            <tr>
                <th>No. of Days</th>
                <th>Minutes</th>
                <th>Conversion</th>
                <th>No. of Days</th>
                <th>Minutes</th>
                <th>Conversion</th>
                <th>No. of Days</th>
                <th>Conversion</th>
            </tr>
        </thead>
        <tbody id="print-table-body">
            </tbody>
    </table>
    <div class="mt-5" style="break-inside: avoid;">
        <div style="float: left; width: 45%;">
            <p>Certified Correct:</p>
            <br><br>
            <p class="fw-bold text-decoration-underline">___________________________</p>
            <p>Administrative Officer V</p>
        </div>
        <div style="float: right; width: 45%; text-align: center;">
            <p>Approved:</p>
            <br><br>
            <p class="fw-bold text-decoration-underline">___________________________</p>
            <p>Schools Division Superintendent</p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, writeBatch, getDocs, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAaU2vOGHM4ugJXGhFLmrAJdXi1bPr8wig",
      authDomain: "dtr-report.firebaseapp.com",
      projectId: "dtr-report",
      storageBucket: "dtr-report.firebasestorage.app",
      messagingSenderId: "759250910768",
      appId: "1:759250910768:web:184cdd2fdd8e30c17cf7f5",
      measurementId: "G-HD3V51NGL7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // Collections
    const reportsCol = collection(db, "monthly_reports_data"); // Holds individual employee records per month
    const employeesCol = collection(db, "master_employees");
    const savedReportsCol = collection(db, "saved_reports"); // Holds metadata for finalized reports

    let currentReportData = [];
    let masterList = [];

    // --- NAVIGATION ---
    window.showView = (viewName, link) => {
        document.querySelectorAll('#sidebar-wrapper .list-group-item').forEach(el => el.classList.remove('active'));
        if(link) link.classList.add('active');
        ['dashboard', 'encoding', 'employees', 'consolidation'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('d-none');
        });
        document.getElementById(`view-${viewName}`).classList.remove('d-none');
        if(viewName === 'consolidation') window.loadSavedReports();
    };
    document.getElementById("menu-toggle").addEventListener("click", (e) => { e.preventDefault(); document.getElementById("wrapper").classList.toggle("toggled"); });

    // --- 1. MASTER LIST ---
    onSnapshot(query(employeesCol, orderBy("name", "asc")), (snap) => {
        masterList = [];
        const tbody = document.getElementById('masterTableBody');
        tbody.innerHTML = '';
        snap.forEach(d => {
            const data = d.data(); data.id = d.id; masterList.push(data);
            tbody.innerHTML += `<tr><td>${masterList.length}</td><td class="fw-bold">${data.name}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" onclick="window.deleteMaster('${data.id}')"><i class="bi bi-trash"></i></button></td></tr>`;
        });
        document.getElementById('dash-master-count').innerText = masterList.length;
    });

    window.importMasterList = () => {
        const fileIn = document.getElementById('masterUpload');
        if(!fileIn.files[0]) return alert("Select file first.");
        const reader = new FileReader();
        reader.readAsArrayBuffer(fileIn.files[0]);
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            const batch = writeBatch(db);
            let count = 0;
            // Heuristic: Data starts around row 16, Name is in Column C (index 2)
            for(let i=15; i<data.length; i++) {
                const name = data[i][2];
                if(name && typeof name==='string' && name.trim() !== "" && !name.includes("Prepared") && !masterList.some(m=>m.name===name)) {
                    batch.set(doc(employeesCol), {name: name.trim()});
                    count++;
                }
            }
            if(count>0) { await batch.commit(); alert(`Imported ${count} new employees.`); } else { alert("No new valid employee names found in the expected column."); }
        };
    };
    window.deleteMaster = async(id) => { if(confirm("Remove this employee from the Master List?")) await deleteDoc(doc(db,"master_employees",id)); }

    // --- 2. MONTHLY ENCODING ---
    const now = new Date();
    const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('filterMonth').value = currentMonthStr;
    
    let monthListenerUnsubscribe = null;

    function loadMonthData(monthStr) {
        if (monthListenerUnsubscribe) monthListenerUnsubscribe(); // Unsubscribe previous listener

        const m = monthStr || document.getElementById('filterMonth').value;
        document.getElementById('dash-month-label').innerText = m;

        const q = query(reportsCol, where("month", "==", m));
        monthListenerUnsubscribe = onSnapshot(q, (snap) => {
            currentReportData = [];
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            snap.forEach(d => { const data = d.data(); data.id = d.id; currentReportData.push(data); });
            currentReportData.sort((a,b) => a.name.localeCompare(b.name));
            
            if(currentReportData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted my-4">No records found for this month. Click "Load Master List" to start.</td></tr>';
            } else {
                currentReportData.forEach(data => {
                    tbody.innerHTML += `
                        <tr>
                            <td class="fw-bold text-start">${data.name}</td>
                            <td>${data.travel||''}</td>
                            <td>${data.leave||''}</td>
                            <td class="text-center">${data.tardyDays||'-'}</td>
                            <td class="text-center">${data.tardyMins||'-'}</td>
                            <td class="text-center small">${data.tardyConv||''}</td>
                            <td class="text-center">${data.underDays||'-'}</td>
                            <td class="text-center">${data.underMins||'-'}</td>
                            <td class="text-center small">${data.underConv||''}</td>
                            <td class="text-center fw-bold bg-success-subtle">${data.totalDays||'-'}</td>
                            <td class="text-center fw-bold bg-success-subtle">${data.totalConv||''}</td>
                            <td class="small text-muted fst-italic text-start">${data.remarks||''}</td>
                            <td><button class="btn btn-sm btn-light border" onclick="window.editRec('${data.id}')"><i class="bi bi-pencil"></i></button></td>
                        </tr>`;
                });
            }
            document.getElementById('dash-month-count').innerText = currentReportData.length;
        });
    }
    document.getElementById('filterMonth').addEventListener('change', (e) => loadMonthData(e.target.value));
    loadMonthData(); // Initial load

    window.populateMonth = async () => {
        const m = document.getElementById('filterMonth').value;
        if(masterList.length === 0) return alert("Master Employee List is empty. Please import employees first.");
        const missing = masterList.filter(emp => !currentReportData.some(r => r.name === emp.name));
        if(missing.length === 0) return alert("All employees from the Master List are already present for this month.");
        
        if(confirm(`Add ${missing.length} missing employees to the ${m} report?`)) {
            const batch = writeBatch(db);
            missing.forEach(emp => {
                const newDocRef = doc(reportsCol);
                batch.set(newDocRef, { 
                    month: m, name: emp.name, 
                    travel:"", leave:"", 
                    tardyDays:"", tardyMins:"", tardyConv:"", 
                    underDays:"", underMins:"", underConv:"", 
                    totalDays:"", totalConv:"", remarks: ""
                });
            });
            try { await batch.commit(); alert("Employees added successfully."); } catch(e) { alert("Error adding employees: " + e.message); }
        }
    };

    // --- SAVE REPORT ACTION ---
    document.getElementById('btnSaveReport').addEventListener('click', async () => {
        const m = document.getElementById('filterMonth').value;
        if(currentReportData.length === 0) return alert("Cannot save an empty report. Please populate the month first.");

        const [year, monthNum] = m.split('-');
        const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long' });
        const reportId = m; // Use YYYY-MM as ID to prevent duplicate months
        const displayName = `DTR - ${monthName} ${year}`;

        try {
            // Check if already exists
            const docSnap = await getDoc(doc(savedReportsCol, reportId));
            if(docSnap.exists()) {
                if(!confirm(`A report for ${displayName} already exists. Do you want to update its "Date Saved" timestamp? (Data is already saved in real-time).`)) return;
            }

            await setDoc(doc(savedReportsCol, reportId), {
                reportId: reportId,
                displayName: displayName,
                month: m,
                savedAt: new Date()
            });
            alert(`Report "${displayName}" has been successfully finalized and saved to the Consolidated Report list.`);
            window.showView('consolidation'); // Take user to the list
        } catch (e) {
            console.error("Error saving report: ", e);
            alert("Failed to save report metadata. See console for details.");
        }
    });


    // --- 3. CONSOLIDATED REPORT (SAVED REPORTS LIST) ---
    window.loadSavedReports = () => {
        const tbody = document.getElementById('savedReportsBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Loading saved reports...</td></tr>';

        onSnapshot(query(savedReportsCol, orderBy("month", "desc")), (snap) => {
            tbody.innerHTML = '';
            if(snap.empty) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No saved reports found. Finalize a report in Monthly Encoding first.</td></tr>';
                return;
            }

            snap.forEach(docSnap => {
                const data = docSnap.data();
                const date SavedStr = data.savedAt ? data.savedAt.toDate().toLocaleString() : 'N/A';
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-primary">${data.displayName}</td>
                        <td>${data.month}</td>
                        <td class="small text-muted">${dateSavedStr}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-dark me-1" onclick="window.printReport('${data.month}', '${data.displayName}')" title="Print Report"><i class="bi bi-printer"></i></button>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="window.downloadReportxls('${data.month}', '${data.displayName}')" title="Download Excel"><i class="bi bi-file-earmark-excel"></i></button>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="window.editReport('${data.month}')" title="Edit Report"><i class="bi bi-pencil-square"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="window.deleteSavedReport('${data.reportId}')" title="Delete Report"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        });
    };

    // --- HELPER: Fetch Data for a specific month ---
    async function getMonthDataForAction(monthStr) {
        const q = query(reportsCol, where("month", "==", monthStr));
        const snap = await getDocs(q);
        const data = [];
        snap.forEach(d => data.push(d.data()));
        return data.sort((a,b) => a.name.localeCompare(b.name));
    }

    // --- ACTION: EDIT REPORT ---
    window.editReport = (monthStr) => {
        document.getElementById('filterMonth').value = monthStr;
        // Manually trigger change event to load data
        document.getElementById('filterMonth').dispatchEvent(new Event('change'));
        window.showView('encoding', document.querySelector('#sidebar-wrapper .list-group-item[onclick*="encoding"]'));
    };

    // --- ACTION: DELETE REPORT ---
    window.deleteSavedReport = async (reportId) => {
        if(!confirm("Are you sure you want to delete this report? This will also delete all individual employee records for this month based on the provided template structure. This action cannot be undone.")) return;

        try {
            const m = reportId; // reportId is the YYYY-MM string
            // 1. Delete monthly data records
            const q = query(reportsCol, where("month", "==", m));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            // 2. Delete the metadata document
            await deleteDoc(doc(savedReportsCol, reportId));
            alert("Report and associated data deleted successfully.");
        } catch (e) {
            console.error("Error deleting report: ", e);
            alert("Failed to delete report. See console.");
        }
    };

    // --- ACTION: PRINT REPORT (HTML Based) ---
    window.printReport = async (monthStr, displayName) => {
        const data = await getMonthDataForAction(monthStr);
        if(data.length === 0) return alert("No data found for this month to print.");

        document.getElementById('print-title').innerText = `Daily Time Record Report - ${displayName.replace('DTR - ', '')}`;
        const tbody = document.getElementById('print-table-body');
        tbody.innerHTML = '';

        data.forEach(rec => {
            tbody.innerHTML += `
                <tr>
                    <td class="text-left" style="font-weight: bold;">${rec.name}</td>
                    <td>${rec.travel}</td>
                    <td>${rec.leave}</td>
                    <td>${rec.tardyDays}</td>
                    <td>${rec.tardyMins}</td>
                    <td>${rec.tardyConv}</td>
                    <td>${rec.underDays}</td>
                    <td>${rec.underMins}</td>
                    <td>${rec.underConv}</td>
                    <td style="font-weight: bold;">${rec.totalDays}</td>
                    <td style="font-weight: bold;">${rec.totalConv}</td>
                    <td class="text-left" style="font-style: italic;">${rec.remarks}</td>
                </tr>`;
        });

        window.print();
    };


    // --- ACTION: DOWNLOAD EXCEL (SheetJS based on Template Structure) ---
    window.downloadReportxls = async (monthStr, displayName) => {
        const data = await getMonthDataForAction(monthStr);
        if(data.length === 0) return alert("No data found for this month to download.");

        // Construct the Excel data array matching the template's layout
        const excelData = [
            ["DEPARTMENT OF EDUCATION"],
            ["Region I"],
            ["San Fernando City (La Union)"],
            [],
            ["DAILY TIME RECORD REPORT"],
            [`For the month of: ${displayName.replace('DTR - ', '')}`],
            [], [], // Spacer rows
            // Header Rows (Rows 9-10 in 0-indexed array, corresponding to rows 14-15 in Excel)
            [
                "NAME OF EMPLOYEE", "TRAVEL", "LEAVE", 
                "TARDINESS", null, null, // Span 3
                "UNDERTIME", null, null, // Span 3
                "GRAND TOTAL", null,     // Span 2
                "REMARKS"
            ],
            [
                null, null, null, // Skip first 3
                "No. of Days", "Minutes", "Conversion",
                "No. of Days", "Minutes", "Conversion",
                "No. of Days", "Conversion",
                null // Skip remarks
            ]
        ];

        // Add Data Rows
        data.forEach(rec => {
            excelData.push([
                rec.name,
                rec.travel,
                rec.leave,
                rec.tardyDays, rec.tardyMins, rec.tardyConv,
                rec.underDays, rec.underMins, rec.underConv,
                rec.totalDays, rec.totalConv,
                rec.remarks
            ]);
        });

        // Create Workbook and Sheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);

        // Define Merges for Headers
        // (s={r,c}, e={r,c}) -> start/end row/col (0-indexed)
        // Header starts at row index 8
        ws['!merges'] = [
             // Main Headers Spans
            { s: {r: 8, c: 3}, e: {r: 8, c: 5} }, // TARDINESS (D9:F9)
            { s: {r: 8, c: 6}, e: {r: 8, c: 8} }, // UNDERTIME (G9:I9)
            { s: {r: 8, c: 9}, e: {r: 8, c: 10} }, // GRAND TOTAL (J9:K9)
            // Rowspans for single headers
            { s: {r: 8, c: 0}, e: {r: 9, c: 0} }, // NAME (A9:A10)
            { s: {r: 8, c: 1}, e: {r: 9, c: 1} }, // TRAVEL (B9:B10)
            { s: {r: 8, c: 2}, e: {r: 9, c: 2} }, // LEAVE (C9:C10)
            { s: {r: 8, c: 11}, e: {r: 9, c: 11} } // REMARKS (L9:L10)
        ];

        // Set column widths for better appearance
        ws['!cols'] = [
            { wch: 30 }, // Name
            { wch: 15 }, // Travel
            { wch: 15 }, // Leave
            { wch: 10 }, { wch: 8 }, { wch: 10 }, // Tardy
            { wch: 10 }, { wch: 8 }, { wch: 10 }, // Under
            { wch: 10 }, { wch: 10 }, // Total
            { wch: 25 }  // Remarks
        ];

        XLSX.utils.book_append_sheet(wb, ws, "DTR Report");
        const fileName = `${displayName.replace(/[^a-zA-Z0-9-_]/g, '_')}.xlsx`;
        XLSX.writeFile(wb, fileName);
    };


    // --- 4. AUTO-CALCULATION LOGIC ---
    function recalculateTotals() {
        const tDays = parseFloat(document.getElementById('inpTardyDays').value) || 0;
        const uDays = parseFloat(document.getElementById('inpUnderDays').value) || 0;
        const tConv = parseFloat(document.getElementById('inpTardyConv').value) || 0;
        const uConv = parseFloat(document.getElementById('inpUnderConv').value) || 0;

        document.getElementById('inpTotalDays').value = tDays + uDays;
        document.getElementById('inpTotalConv').value = (tConv + uConv).toFixed(3);
    }

    // --- 5. EDIT & SAVE RECORD (Modal) ---
    window.editRec = (id) => {
        const rec = currentReportData.find(r=>r.id===id);
        if(!rec) return;
        document.getElementById('editId').value = rec.id;
        document.getElementById('editNameDisplay').innerText = rec.name;
        document.getElementById('inpRemarks').value = rec.remarks || '';
        
        ['Travel','Leave','TardyDays','TardyMins','TardyConv','UnderDays','UnderMins','UnderConv','TotalDays','TotalConv'].forEach(k => {
             document.getElementById(`inp${k}`).value = rec[k.charAt(0).toLowerCase()+k.slice(1)] || '';
        });

        const calcInputs = ['inpTardyDays', 'inpUnderDays', 'inpTardyConv', 'inpUnderConv'];
        calcInputs.forEach(id => {
            const el = document.getElementById(id);
            el.removeEventListener('input', recalculateTotals);
            el.addEventListener('input', recalculateTotals);
        });

        new bootstrap.Modal(document.getElementById('editModal')).show();
    };

    document.getElementById('btnSave').addEventListener('click', async () => {
        const id = document.getElementById('editId').value;
        const payload = { remarks: document.getElementById('inpRemarks').value };
        ['Travel','Leave','TardyDays','TardyMins','TardyConv','UnderDays','UnderMins','UnderConv','TotalDays','TotalConv'].forEach(k => {
             payload[k.charAt(0).toLowerCase()+k.slice(1)] = document.getElementById(`inp${k}`).value;
        });
        try {
            await updateDoc(doc(reportsCol, id), payload);
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        } catch(e) { alert("Save failed: " + e.message); }
    });

</script>
</body>
</html>

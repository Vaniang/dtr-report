<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DepEd DTR Monitoring System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { overflow-x: hidden; background-color: #f4f6f9; }
        /* Sidebar Styling */
        #sidebar-wrapper {
            min-height: 100vh;
            margin-left: -15rem;
            transition: margin .25s ease-out;
            background-color: #343a40;
            color: white;
        }
        #sidebar-wrapper .sidebar-heading { padding: 0.875rem 1.25rem; font-size: 1.2rem; border-bottom: 1px solid #4b545c; }
        #sidebar-wrapper .list-group-item { background-color: #343a40; color: #c2c7d0; border: none; }
        #sidebar-wrapper .list-group-item:hover { background-color: #495057; color: #fff; }
        #sidebar-wrapper .list-group-item.active { background-color: #007bff; color: #fff; }
        #wrapper.toggled #sidebar-wrapper { margin-left: 0; }
        .stat-card { border-left: 5px solid #007bff; }
        .table-sm td, .table-sm th { font-size: 0.9rem; vertical-align: middle; }
    </style>
</head>
<body>

<div class="d-flex" id="wrapper">
    <div class="border-end" id="sidebar-wrapper" style="width: 240px; margin-left: 0;">
        <div class="sidebar-heading fw-bold">DTR MONITORING</div>
        <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action active" onclick="showView('dashboard', this)">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showView('encoding', this)">
                <i class="bi bi-pencil-square me-2"></i> Report Encoding
            </a>
            <a href="#" class="list-group-item list-group-item-action" onclick="showView('settings', this)">
                <i class="bi bi-gear me-2"></i> Settings
            </a>
        </div>
    </div>

    <div id="page-content-wrapper" class="w-100">
        <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-3">
            <button class="btn btn-outline-secondary btn-sm" id="menu-toggle"><i class="bi bi-list"></i></button>
            <div class="ms-auto fw-bold text-primary">Region I - San Fernando City</div>
        </nav>

        <div class="container-fluid p-4">
            
            <div id="view-dashboard">
                <h3 class="mb-4">Dashboard Overview</h3>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="card shadow-sm stat-card p-3">
                            <h6 class="text-muted">Total Employees</h6>
                            <h2 id="dash-total">0</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm stat-card p-3" style="border-color: #dc3545;">
                            <h6 class="text-muted">Total Tardiness (Mins)</h6>
                            <h2 id="dash-tardy">0</h2>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card shadow-sm stat-card p-3" style="border-color: #ffc107;">
                            <h6 class="text-muted">With Travel/Leave</h6>
                            <h2 id="dash-leaves">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-encoding" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Monthly Report Encoding</h3>
                    <div class="d-flex gap-2">
                         <input type="month" id="filterMonth" class="form-control" value="2026-01">
                         <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editModal" onclick="resetForm()">
                            <i class="bi bi-plus-lg"></i> Add New
                         </button>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm">
                                <thead class="table-light text-center">
                                    <tr>
                                        <th rowspan="2" style="vertical-align: middle;">Name of Employee</th>
                                        <th rowspan="2" style="vertical-align: middle;">Travel</th>
                                        <th rowspan="2" style="vertical-align: middle;">Leave</th>
                                        <th colspan="3">Tardiness</th>
                                        <th colspan="3">Undertime</th>
                                        <th colspan="2">Grand Total</th>
                                        <th rowspan="2" style="vertical-align: middle;">Action</th>
                                    </tr>
                                    <tr style="font-size: 0.8rem;">
                                        <th>Days</th><th>Mins</th><th>Conv</th>
                                        <th>Days</th><th>Mins</th><th>Conv</th>
                                        <th>Days</th><th>Conv</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-4 bg-light border-0">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-file-earmark-spreadsheet"></i> Generate Excel Report</h5>
                        <p class="text-muted small">Upload your 'DTR 2026.xlsx' template. The system will match names and fill the data.</p>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="file" id="templateFile" class="form-control" accept=".xlsx">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success w-100" id="btnGenerate">Generate</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <div id="view-settings" class="d-none">
                <h3>Settings</h3>
                <p>System configuration...</p>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Edit Employee Record</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                
                <div class="mb-3">
                    <label class="fw-bold">Employee Name</label>
                    <input type="text" id="inpName" class="form-control" placeholder="Lastname, Firstname M.">
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label>Travel (Dates)</label>
                        <input type="text" id="inpTravel" class="form-control" placeholder="e.g. 6-9, 14-15">
                    </div>
                    <div class="col-md-6">
                        <label>Leave (Dates)</label>
                        <input type="text" id="inpLeave" class="form-control" placeholder="e.g. 29-30">
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4 p-2 bg-light border rounded">
                        <h6 class="text-danger">Tardiness</h6>
                        <input type="number" id="inpTardyDays" class="form-control mb-1" placeholder="Days">
                        <input type="number" id="inpTardyMins" class="form-control mb-1" placeholder="Mins">
                        <input type="number" id="inpTardyConv" class="form-control" placeholder="Conv">
                    </div>
                    <div class="col-md-4 p-2 bg-light border rounded">
                        <h6 class="text-warning text-dark">Undertime</h6>
                        <input type="number" id="inpUnderDays" class="form-control mb-1" placeholder="Days">
                        <input type="number" id="inpUnderMins" class="form-control mb-1" placeholder="Mins">
                        <input type="number" id="inpUnderConv" class="form-control" placeholder="Conv">
                    </div>
                    <div class="col-md-4 p-2 bg-light border rounded">
                        <h6 class="text-success">Grand Total</h6>
                        <input type="number" id="inpTotalDays" class="form-control mb-1" placeholder="Total Days">
                        <input type="number" id="inpTotalConv" class="form-control" placeholder="Total Conv">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnSave">Save Record</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaU2vOGHM4ugJXGhFLmrAJdXi1bPr8wig",
      authDomain: "dtr-report.firebaseapp.com",
      projectId: "dtr-report",
      storageBucket: "dtr-report.firebasestorage.app",
      messagingSenderId: "759250910768",
      appId: "1:759250910768:web:184cdd2fdd8e30c17cf7f5",
      measurementId: "G-HD3V51NGL7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "monthly_reports");

    let currentData = [];

    // --- VIEW CONTROLLER ---
    window.showView = (viewName, link) => {
        document.querySelectorAll('#sidebar-wrapper .list-group-item').forEach(el => el.classList.remove('active'));
        if(link) link.classList.add('active');
        
        ['dashboard', 'encoding', 'settings'].forEach(v => {
            document.getElementById(`view-${v}`).classList.add('d-none');
        });
        document.getElementById(`view-${viewName}`).classList.remove('d-none');
    };

    // Sidebar Toggle
    document.getElementById("menu-toggle").addEventListener("click", function(e) {
        e.preventDefault();
        document.getElementById("wrapper").classList.toggle("toggled");
    });

    // --- DATA LOADING ---
    const monthPicker = document.getElementById('filterMonth');
    
    function loadData() {
        const selectedMonth = monthPicker.value;
        const q = query(colRef, where("month", "==", selectedMonth));

        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = '';
            currentData = [];
            
            // Dashboard Stats
            let totalMins = 0;
            let withIssues = 0;

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                data.id = docSnap.id;
                currentData.push(data);

                // Stats
                totalMins += Number(data.tardyMins || 0);
                if(data.travel || data.leave) withIssues++;

                const row = `
                    <tr>
                        <td class="fw-bold">${data.name}</td>
                        <td>${data.travel || ''}</td>
                        <td>${data.leave || ''}</td>
                        <td class="text-center">${data.tardyDays || ''}</td>
                        <td class="text-center">${data.tardyMins || ''}</td>
                        <td class="text-center">${data.tardyConv || ''}</td>
                        <td class="text-center">${data.underDays || ''}</td>
                        <td class="text-center">${data.underMins || ''}</td>
                        <td class="text-center">${data.underConv || ''}</td>
                        <td class="text-center fw-bold">${data.totalDays || ''}</td>
                        <td class="text-center fw-bold">${data.totalConv || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.editRec('${data.id}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="window.delRec('${data.id}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update Dashboard
            document.getElementById('dash-total').innerText = currentData.length;
            document.getElementById('dash-tardy').innerText = totalMins;
            document.getElementById('dash-leaves').innerText = withIssues;
        });
    }

    monthPicker.addEventListener('change', loadData);
    loadData(); // Initial Load

    // --- CRUD OPERATIONS ---

    window.resetForm = () => {
        document.getElementById('editId').value = '';
        document.querySelectorAll('#editModal input').forEach(i => i.value = '');
    };

    window.editRec = (id) => {
        const rec = currentData.find(r => r.id === id);
        if(!rec) return;

        document.getElementById('editId').value = rec.id;
        document.getElementById('inpName').value = rec.name;
        document.getElementById('inpTravel').value = rec.travel;
        document.getElementById('inpLeave').value = rec.leave;
        
        document.getElementById('inpTardyDays').value = rec.tardyDays;
        document.getElementById('inpTardyMins').value = rec.tardyMins;
        document.getElementById('inpTardyConv').value = rec.tardyConv;

        document.getElementById('inpUnderDays').value = rec.underDays;
        document.getElementById('inpUnderMins').value = rec.underMins;
        document.getElementById('inpUnderConv').value = rec.underConv;

        document.getElementById('inpTotalDays').value = rec.totalDays;
        document.getElementById('inpTotalConv').value = rec.totalConv;

        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    };

    window.delRec = async (id) => {
        if(confirm("Delete this record?")) {
            await deleteDoc(doc(db, "monthly_reports", id));
        }
    };

    document.getElementById('btnSave').addEventListener('click', async () => {
        const id = document.getElementById('editId').value;
        const payload = {
            month: monthPicker.value,
            name: document.getElementById('inpName').value,
            travel: document.getElementById('inpTravel').value,
            leave: document.getElementById('inpLeave').value,
            
            tardyDays: document.getElementById('inpTardyDays').value,
            tardyMins: document.getElementById('inpTardyMins').value,
            tardyConv: document.getElementById('inpTardyConv').value,

            underDays: document.getElementById('inpUnderDays').value,
            underMins: document.getElementById('inpUnderMins').value,
            underConv: document.getElementById('inpUnderConv').value,

            totalDays: document.getElementById('inpTotalDays').value,
            totalConv: document.getElementById('inpTotalConv').value
        };

        if(id) {
            await updateDoc(doc(db, "monthly_reports", id), payload);
        } else {
            await addDoc(colRef, payload);
        }
        
        // Hide Modal manually
        const modalEl = document.getElementById('editModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    });

    // --- EXCEL GENERATION (THE MAGIC) ---
    document.getElementById('btnGenerate').addEventListener('click', () => {
        const fileInput = document.getElementById('templateFile');
        if (!fileInput.files[0]) return alert("Please upload the template file first.");
        
        const reader = new FileReader();
        reader.readAsArrayBuffer(fileInput.files[0]);

        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // Get all data from sheet to find row numbers
            const sheetData = XLSX.utils.sheet_to_json(sheet, {header: 1});

            // Iterate over our database records
            currentData.forEach(rec => {
                // Find matching row in Excel (Column C / Index 2 contains Name)
                let rowIdx = -1;
                for(let i=0; i < sheetData.length; i++) {
                    // Check if name matches (loose check)
                    if(sheetData[i][2] && typeof sheetData[i][2] === 'string' && sheetData[i][2].includes(rec.name)) {
                        rowIdx = i;
                        break;
                    }
                }

                if(rowIdx !== -1) {
                    // Helper to write to cell
                    const write = (col, val) => {
                        const cellRef = XLSX.utils.encode_cell({c: col, r: rowIdx});
                        if(!sheet[cellRef]) sheet[cellRef] = {t:'s', v:''};
                        sheet[cellRef].v = val;
                    };

                    // MAP DATA TO COLUMNS (Based on your CSV analysis)
                    // Col 3: Travel, 4: Leave, 5: TardyDays, 6: TardyMins, 7: TardyConv
                    // 8: UnderDays, 9: UnderMins, 10: UnderConv, 11: GrandDays, 12: GrandConv
                    if(rec.travel) write(3, rec.travel);
                    if(rec.leave) write(4, rec.leave);
                    if(rec.tardyDays) write(5, Number(rec.tardyDays));
                    if(rec.tardyMins) write(6, Number(rec.tardyMins));
                    if(rec.tardyConv) write(7, Number(rec.tardyConv));
                    
                    if(rec.underDays) write(8, Number(rec.underDays));
                    if(rec.underMins) write(9, Number(rec.underMins));
                    if(rec.underConv) write(10, Number(rec.underConv));
                    
                    if(rec.totalDays) write(11, Number(rec.totalDays));
                    if(rec.totalConv) write(12, Number(rec.totalConv));
                }
            });

            // Download
            XLSX.writeFile(workbook, `Generated_Report_${monthPicker.value}.xlsx`);
        };
    });
</script>

</body>
</html>
